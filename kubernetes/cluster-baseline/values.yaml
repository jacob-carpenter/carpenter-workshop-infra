# Cluster Baseline Configuration
# This file configures the core infrastructure services for the cluster

clusterName: carpenter-workshop-core
environment: prod

# Namespace configuration
namespace:
  create: true
  name: cluster-baseline

# AWS Load Balancer Controller - Manages ALB/NLB via Kubernetes Ingress
aws-load-balancer-controller:
  enabled: true

  # Cluster name - must match VPC tags
  clusterName: carpenter-workshop-prod

  # Service account configuration
  serviceAccount:
    create: true
    name: aws-load-balancer-controller
    # Note: Using EC2 instance profile instead of IRSA for K3s
    # The IAM policies are attached to the worker nodes' IAM role

  # VPC ID will be auto-discovered via EC2 instance metadata
  # Region will be auto-discovered

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # High availability
  replicaCount: 2

  # Pod disruption budget
  podDisruptionBudget:
    maxUnavailable: 1

  # Keep pods on different nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - aws-load-balancer-controller
            topologyKey: kubernetes.io/hostname

  # Enable logging
  enableShield: false
  enableWaf: false
  enableWafv2: false

# external-dns - Automatic DNS management for Kubernetes Ingress/Service
external-dns:
  enabled: true

  # Provider configuration
  provider: aws

  # AWS Route 53 configuration
  aws:
    region: us-east-1
    # Zone filtering - only manage specific hosted zones
    zoneType: public
    # Optionally restrict to specific zones (leave empty to manage all zones)
    # zoneIdFilters:
    #   - Z1234567890ABC

  # Source configuration - which Kubernetes resources to monitor
  sources:
    - ingress
    - service

  # Domain filter - only manage DNS for these domains
  domainFilters:
    - carpenterworkshop.net

  # Policy - how to handle existing DNS records
  # upsert-only: Only create/update records, never delete
  # sync: Full synchronization (create, update, delete)
  policy: upsert-only

  # Interval to check for changes
  interval: 1m

  # Registry configuration - store record ownership info
  registry: txt
  txtOwnerId: carpenter-workshop-prod

  # Resource limits
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Service account configuration
  serviceAccount:
    create: true
    name: external-dns
    # Using EC2 instance profile for permissions

  # Pod security context
  securityContext:
    fsGroup: 65534
    runAsNonRoot: true
    runAsUser: 65534

  # Log configuration
  logLevel: info
  logFormat: text

# Cert-Manager - Automatic SSL certificate management
cert-manager:
  enabled: false  # Disabled - using ACM certificates with ALB instead
  createClusterIssuer: false  # Don't create Let's Encrypt issuer (using ACM)

  # Install CRDs
  installCRDs: true

  # Resource limits
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  webhook:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

  cainjector:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

  # Prometheus metrics
  prometheus:
    enabled: false  # Enable if using Prometheus

# Metrics Server - Required for HPA
metrics-server:
  enabled: false

  args:
    - --kubelet-insecure-tls  # Required for K3s
    - --kubelet-preferred-address-types=InternalIP

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ECR Credential Helper - Automatic ECR authentication for private registries
ecrCredentialHelper:
  enabled: true

  # AWS ECR Configuration
  ecr:
    region: us-east-1
    registryAccount: "740474257663"

  # Namespaces where the ECR secret should be created
  # Add any new namespaces here that need to pull from ECR
  targetNamespaces:
    - carpenter-workshop
    - default

  # Secret name to create/update (must match your app deployments)
  secretName: ecr-secret

  # Service Account
  serviceAccount:
    name: ecr-credential-helper
    annotations: {}
    # If migrating to EKS with IRSA, add:
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/ROLE_NAME

  # Resources for the credential helper pods
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  # Node selector - run on control-plane node which has internet access
  # Worker nodes are in private subnets without NAT gateway
  nodeSelector:
    node-role.kubernetes.io/control-plane: "true"

  # Image with both AWS CLI v2 and kubectl pre-installed
  # Using a lightweight image that has both tools ready to go
  image:
    repository: alpine/k8s
    tag: 1.28.3
    pullPolicy: IfNotPresent
